
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script src="http://code.jquery.com/jquery-3.7.1.min.js"></script>
    <style>
        .madListTbl{
            border: 1px solid black;
            width: 100%;
            border-collapse: collapse;
        }
        .madListTbl tr th{
            border: 1px solid black;
        }
        .madListTbl tr td{
            border: 1px solid black;
            text-align: center;
            
        }
        .subtbl{
            opacity: initial;
            border: 0px solid black;
            width: 97%;
            border-collapse: collapse;
            margin: 10px 10px 10px 10px;
        }
        .subtbl tr td{
            border: 0px solid black;
            border-top: 1px solid black;
            padding: 10px 0px;

        }
    </style>

    <script>
      //1.ajax에서 요청을 보냄
      //2.서버에서 요청을 받음
      //3.서버에서 요청처 후 ajax에 반환
      //4.ajax는 성공과 에러 따라 함수 실행
    $(document).ready(function(){
        //초기에 표그려주는 함수 + 매게주면 검섹 가능
      function drawing(listData){
          //console.log(listData);
          $.ajax({
          url:"http://localhost:3000/data",
          type:"GET",
          data:listData,
          success(data){
            //console.log(data);
            const memberList =data.memberListdata;
            //console.log(memberList);
            const noCnt = data.noCnt;
            let memberstr = "";
            memberList.forEach(member => {
              var commentstr= "";
              member.commentList.forEach(comment =>{
                commentstr +=
                `
                  <tr data-seq="${member.seq}">
                    <td>${comment.seq}</td>
                    <td>${comment.comment}</td>
                    <td>${comment.name}</td>
                    <td><button type="button" onclick="modify(this)">수정</button></td>
                    <td><button type="button" onclick="listDelete(this)">삭제</button></td>
                  <tr>
                `;
              });
              memberstr +=`
                <tr data-seq="${member.seq}">
                  <td rowspan="2"><input type="checkbox" ${member.ckBox?"checked":""}></td>
                  <td rowspan="2">${member.seq}</td>
                  <td><img src="" width="300" height="200"></td>
                  <td>${member.name}</td>
                  <td>${member.department}</td>
                  <td>${member.rank}</td>
                  <td rowspan="2"><button onclick="modify(this)">수정</button></td>
                  <td rowspan="2"><button onclick="listDelete(this)">삭제</button></td>
                </tr>
                <tr data-seq="${member.seq}">
                    <td colspan="4">
                        <table with="100%" class="subtbl">
                            <tbody>
                                <tr>
                                    <td>번호</td>
                                    <td>댓글 내용</td>
                                    <td>작성자</td>
                                    <td>수정</td>
                                    <td>삭제</td>
                                </tr>
                            </tbody>
                            <tbody>
                            ${commentstr}
                            </tbody>
                            <tbody>
                                <tr>
                                    <td colspan="5" data-seq="${member.seq}">
                                      <form>
                                        댓글
                                        <input type="text" value="" style="width: 50%; margin: 5px; ">
                                        작성자
                                        <input type="text" value="" style="width: 50px;">
                                        <button type="button" onclick="addcommen(this)">댓글입력</button>
                                      </form>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </td>
                </tr>
              `;
            });
            $("#comment").html(memberstr);
          },error(data){
            console.log("통신 실패");
          }
        });
      };
      drawing();

    //큰표 생성,수정,삭제,검색 함수들

    //큰표 목록 추가 함수
      $("#submitBtn").click(function(){
        var formData1 = $("#formData").serialize();
        //console.log(formData1);
        $.ajax({
          type:"POST",
          url:'http://localhost:3000/input',
          data:formData1,
          success: function(data){
            drawing();
          },
          error: function(data){
            console.log("실패");
          }
        })
    });

    //큰표 수정 함수
      HTMLButtonElement.prototype.modify = function(memberListdata){
      var trElement = memberListdata.parentElement.parentElement
      var seq = trElement.dataset.seq;
      var cells = trElement.cells;
      // if문으로 큰표 수정 인지 작은 수정인지 판별!
      if(cells.length == 8){
        for (let index = 3; index < 6; index++) {
          //수정이 가능한 사원병, 부서, 직급에 input칸으로 변경
          var text=cells[index].childNodes[0].data;
          cells[index].innerHTML=`<td><input id="input${+index}"type="text" value="${text}"></td>`;
        }
        //기존 수정 버튼 온클릭 하고 수정완료로 변경
        cells[6].innerHTML=`<td rowspan="2"><button id="modifyBtn" >수정완료</button></td>`;
        
        //큰은표 수정 온클릭 함수&서버요청
        $('#modifyBtn').click(function(){
          var name = document.getElementById('input3').value;
          var department = document.getElementById('input4').value;
          var rank = document.getElementById('input5').value;
          
          $.ajax({
            type:"PUT",
            url:"http://localhost:3000/modify",
            //식별코드 ,변경된이름, 변경된부서,변경된직급,
            data:{seq,name,department,rank},
            success: function(data){
              drawing();
            },
            error: function(data){
              console.log("실패");
            }
          })
        })

      }else if(cells.length== 5){
        //작은 표에 수정가능한 댓글에 input만들어주기
        var text=cells[1].childNodes[0].data;
        var commentseq=cells[0].childNodes[0].data;
        cells[1].innerHTML=`<td><input id="input1"type="text" value="${text}"></td>`;
        
        //큰표에서 똑같이 수정버튼 재활용
        cells[3].innerHTML=`<td rowspan="2"><button id="cModifyBtn" >수정완료</button></td>`;
        

        //작은표 수정 온클릭 함수&서버요청
        $('#cModifyBtn').click(function(){
          console.log(commentseq)
          //댓글만 변경 가능 하게 이름 쪽 인풋 받아오는 변수 주석처리함
          // 주석만 치우면 이름도 변경가능
          //var name = document.getElementById('input2').value;
          var comment = document.getElementById('input1').value;

          $.ajax({
            type:"PUT",
            url:"http://localhost:3000/modify",
            //데이터는 작은표 식별을 위한 seq 두번째는 댓글내용
            //세번째는 특정 댓글 수정를 위한 댓글 seq
            data:{seq,comment,commentseq},
            success: function(data){
              drawing();
            },
            error: function(data){
              console.log("실패");
            }
          })
        })
      }
    }


    //큰표삭제 함수
      HTMLButtonElement.prototype.listDelete = function(memberListdata){
      var trElement=memberListdata.parentElement.parentElement;
      var seq =trElement.dataset.seq;
      var commentseq=trElement.cells[0].childNodes[0].data;
      console.log(seq,commentseq);
      $.ajax({
        type:"DELETE",
        url:"http://localhost:3000/delete",
        data: {seq,commentseq},
        success: function(data){
          drawing();
        },
        error: function(data){
          console.log("실패");
        }
      })
    }

    //큰표검색
      $('#searchBnt').click(function(){
        var formData1 = $("#searchform").serialize();
        $.ajax({
          type:"GET",
          url:"http://localhost:3000/search",
          data: formData1,
          dataType: "JSON",
          success: function(data){
            drawing(data);
            //console.log(data);
          },
          error: function(daat){
            console.log(1);
          }
        })
      })

    //작은 표 추가,삭제,수정

    //작은 표 추가 함수
      HTMLButtonElement.prototype.addcommen = function(commen){
      var trElement = commen.parentElement.parentElement
      var seq =trElement.dataset.seq;
      var comment = trElement.childNodes[1][0].value;
      var name =trElement.childNodes[1][1].value;
      console.log(seq,comment,name)
      $.ajax({
        type:"POST",
        url:'http://localhost:3000/input',
        data:{seq,comment,name},
        success: function(data){
          drawing();
        },
        error: function(data){
          console.log("실패");
        }
      });
      

    }

    //작은 표 삭제 함수 큰 표쪽에 통합 됨

    //작은 표 수정 함수 표쪽에 통합 됨

  });
    </script>
</head>
<body>
    <form id="formData" >
        이름<input name="nameIput" type="text" value=""><br>
        부서<input name="departmentIput"type="text" value=""><br>
        직책<input name="rankIput" type="text" value=""><br>
        사진<button type="button" id="imgIputBtn">파일 선택</button> 선택된 파일 없음<br>
        <br>
        <button id="submitBtn" type="button" style="border: 0; border-radius: 5px; background-color: rgb(211, 51, 51); color: white; width: 100px; height: 30px;">새 사원 추가</button>
    </form>

    <hr>

    <form id ="searchform">
        <input type="button" value="선택 삭제"> 
        | 검색: 
        <select name="select">
            <option value="name">이름</option>
            <option value="department">부서</option>
            <option value="rank">직책</option>
        </select>
        <input name="searchIput" type="text">
        <button id="searchBnt" type="button" >검색</button>
    </form>
    <table class="madListTbl" >
      <thead>
        <tr style="background-color:orange">
            <th><input type="checkbox"></th>
            <th>번호</th>
            <th>사진</th>
            <th>사원명</th>
            <th>부서</th>
            <th>직급</th>
            <th>수정</th>
            <th>삭제</th>
        </tr>
      </thead>
      <tbody id="comment">
        
      </tbody>
      
    </table>
    
</body>
</html>